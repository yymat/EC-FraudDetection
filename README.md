<div id="top"></div>

<!-- ## 使用技術 -->
<!-- シールド一覧 -->
<!-- https://t8csp.csb.app/ -->
<p style="display: inline">
  <img src="https://img.shields.io/badge/-Python-F9DC3E.svg?logo=python&style=flat">
  <img src="https://img.shields.io/badge/-Power%20Automate%20Desktop-5391FE.svg?logo=Power%20Automate&style=popout"
</p>

# ECサイトの不正注文対策として、不正検知システムの導入の敷居が高いので内製した

# 不正検知システムの費用が高くなる原因

1. 住所の名寄せ（正規化）の難易度が高い

   一例として、同じ住所の書き方が膨大にあり処理が必要（単純なところで漢数字と数字とか）

   有料の住所正規化サービスがいくつもあるぐらいで、簡単に内製できるレベルではない

2. 不正ユーザーのブラックリストが作れない

   不正なユーザーとわかってブラックリストを作る必要があるが自社だけだとすでに損害を受けている状態

   多数のECサイト、カード会社からの情報が必要なため内製できない

   システムを利用すると1件数円～数十円の経費がかかるのだが、1日1万件、1件10円だとひと月は300万円の費用になるので費用対効果に疑問が生じる状態でした

   （転売しにくい商品を扱うECサイトだったため。さらにベンダーのサイト改修費も必要

   家電など単価が高いとシステム導入が有効だと思います）

# 内製する方法
API等で都度検知ではなく、1日の注文情報と不正情報を突き合わせる方式で作成しました

1. 住所の正規化対応
   [商用サービス並みに高精度な住所正規化用のNodeモジュールを公開しました！](https://blog.geolonia.com/2021/03/28/normalize-japanese-addresses.html)

   こちらのPythonに書き換えてくれたライブラリ[normalize-japanese-addresses](https://pypi.org/project/normalize-japanese-addresses/)を利用しました

   （pythonを使ったのはPythonでブラウザ操作をする予定があったから）

2. ブラックリストの入手
   こちらはSBペイメントサービス株式会社の不正配送先情報サービスを利用します。（申請後に無料で利用可能）

   不正配送先情報リストをダウンロードできるのでこちらを使用します

   これは各種カード会社から不正利用のあった住所情報をまとめたものです。各カード会社から情報が集まっているのでブラックリストとして使えます

4. ブラックリストの住所の正規化を行う（週1ぐらいでもOK）

5. 注文データを取得する

   Pythonでブラウザ操作で行えばいいと思います

   （私はすでにPower Automate Desktopで作ってあったものがあったので流用して使用しました）

6. 正規化した注文データの住所と、ブラックリストの住所をマッチングさせる

   ただし、マンション名＋部屋番号までのマッチングは正規化が別に必要になるために建物名は使用しない

7. マッチングした情報をCSV形式で作成し、（部屋番号が一致しているか等を）目視で確認する

   （不正利用できそうな商品がすくないためか、1日に数件しかマッチしなかったのでチェックは5分もかからなかったです。）


# 注意点

normalize-japanese-addressesの使用でkanjizeが必要ですが、2023/3時点ではエラーになりました。

```ImportError: cannot import name 'kanji2int' from 'kanjize'```

normalize-japanese-addresses 0.0.5の場合は以下の対応が必要でした。

```pip install kanjize==1.2.0```

Pythonで2番目に作ったプログラム。とりま動く形なだけなので、作りだけ公開しました。
